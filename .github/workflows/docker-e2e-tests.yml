name: Docker E2E Tests

on:
    workflow_dispatch:
        inputs:
            browser:
                description: "Browser to run tests on"
                required: true
                default: "chromium"
                type: choice
                options:
                    - chromium
                    - firefox
                    - webkit
                    - all
            workers:
                description: "Number of parallel workers"
                required: true
                default: "2"
                type: choice
                options:
                    - "1"
                    - "2"
                    - "3"
                    - "4"
            tag:
                description: "Test tag filter (e.g., @login, @smoke)"
                required: false
                type: string
            test_path:
                description: "Test path to run"
                required: true
                default: "tests"
                type: string

jobs:
    docker-test:
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: false
                  load: true
                  tags: playwright-tests:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Run Playwright tests in Docker
              run: |
                  # Create output directories with proper permissions
                  mkdir -p playwright-report test-results

                  TEST_CMD="npx playwright test ${{ inputs.test_path }} --retries=1"

                  # Add browser project filter
                  if [ "${{ inputs.browser }}" != "all" ]; then
                    TEST_CMD="$TEST_CMD --project=${{ inputs.browser }}"
                  fi

                  # Add workers
                  TEST_CMD="$TEST_CMD --workers=${{ inputs.workers }}"

                  # Add tag filter if provided
                  if [ -n "${{ inputs.tag }}" ]; then
                    TEST_CMD="$TEST_CMD --grep ${{ inputs.tag }}"
                  fi

                  docker run --rm \
                    -v ${{ github.workspace }}/playwright-report:/app/playwright-report \
                    -v ${{ github.workspace }}/test-results:/app/test-results \
                    -e CI=true \
                    --user root \
                    playwright-tests:latest $TEST_CMD

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-report-docker
                  path: playwright-report/
                  retention-days: 10

            - name: Upload test artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results-docker
                  path: test-results/
                  retention-days: 10
